name: Daily 5PM Maggie Summary

on:
  schedule:
    - cron: "0 23 * * *"  # 23:00 UTC = 5:00 PM America/Denver most of the year
  workflow_dispatch:

permissions:
  contents: read

jobs:
  summary:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch Worker daily summary
        id: pull
        run: |
          set -e
          curl -sS "https://maggie.messyandmagnetic.com/summary" \
            -H "Authorization: Bearer ${{ secrets.POST_THREAD_SECRET }}" \
            -o summary.json
          echo "text<<EOF" >> $GITHUB_OUTPUT
          jq -r '
            def n(x): if x==null then "0" else (x|tostring) end;
            def status(entry):
              if entry == null then "âšªï¸ pending" else
                (if entry.ok == true then "âœ…" elif entry.ok == false then "âŒ" else "âšªï¸" end) + " " +
                (if ((entry.issues // []) | length) > 0 then (entry.issues // [])[0]
                 elif ((entry.warnings // []) | length) > 0 then (entry.warnings // [])[0]
                 elif (entry.detail//"") != "" then entry.detail
                 elif (entry.checkedAt//"") != "" then "checked " + entry.checkedAt
                 else "pending" end)
              end;
            "ðŸ“’ Maggie Daily Summary\n" +
            "â° " + (.time // "unknown") + "\n" +
            "ðŸ§© Tasks: " + ((.currentTasks // ["idle"]) | join(", ")) + "\n" +
            "ðŸŒ Website: " + status(.health.website) + "\n" +
            "ðŸ§  Tally quiz: " + status(.health.tally) + "\n" +
            "ðŸ’¸ Stripe: " + status(.health.stripe) + "\n" +
            "ðŸŽµ TikTok: " + n(.socialQueue.scheduled) + " scheduled | " + n(.socialQueue.flopsRetry) + " retries\n" +
            "â™»ï¸ Flops recovered: " + n(.metrics.flopsRecovered) + "\n" +
            (if .topTrends then "ðŸ”¥ Top Trends: " + (.topTrends | map(.title) | join(", ")) else "" end)
          ' summary.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send Telegram
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            --data-urlencode text="${{ steps.pull.outputs.text }}"
