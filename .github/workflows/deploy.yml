name: Deploy Maggie (Cloudflare Workers)

on:
  push:
    branches: [main]
    paths:
      - "worker/**"
      - "mags-runner/**"
      - "wrangler.toml"
      - "mags-runner/wrangler.toml"
      - "package.json"
      - "pnpm-lock.yaml"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.15.0

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install deps
        run: pnpm i --frozen-lockfile=false

      # Deploy the PUBLIC worker (root wrangler.toml)
      - name: Deploy public worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: npx wrangler deploy -c wrangler.toml --minify

      # Deploy the RUNNER worker (mags-runner/wrangler.toml)
      - name: Deploy runner worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: npx wrangler deploy -c mags-runner/wrangler.toml --minify